# uspack
#
# produce source code zip for csvfix

ALIB=alib
CSVFIX=csvfix
TEMP=csvfix-build
ZIPPER="C:\Program Files\7-Zip\7z.exe"

error() {
	echo "ERROR: $*"
	exit 1
}

create_dir() {
	echo "copying $1 ..."
	mkdir "$TEMP/$1"
	mkdir "$TEMP/$1/src"
	mkdir "$TEMP/$1/inc"
	mkdir "$TEMP/$1/obj"
	cp $1/src/*.cpp "$TEMP/$1/src"
	cp $1/inc/*.h "$TEMP/$1/inc"
	cp $1/Makefile "$TEMP/$1"
}

create_tests() {
	echo "copying tests..."
	cp -r $1/tests "$TEMP/$1"
	rm -f $TEMP/$1/tests/tmp/*
}

if [ "$1" = "" ]
then
	error "need to specify name of output zip file"
fi

if [ -d "$1" -o -f "$1" ]
then
	error "$1 already exists" 
fi
ZIPOUT=$1

if [ ! -d "$ALIB" ]
then
	error "$ALIB directory not found"
fi

if [ ! -d "$CSVFIX" ]
then
	error "$CSVFIX directory not found"
fi

if [ -d "$TEMP" ]
then
	error "$TEMP directory already exist"
fi

if mkdir "$TEMP"
then
	echo "creating temporary directories..."
	create_dir "$CSVFIX" 
	create_tests "$CSVFIX"
	create_dir "$ALIB" 
	cp Makefile "$TEMP"
	cp LICENSE readme.txt "$TEMP"
	mkdir "$TEMP/$CSVFIX/bin"
	mkdir "$TEMP/$ALIB/lib"
	mkdir "$TEMP/$ALIB/expat"
	cp $ALIB/expat/*.h "$TEMP/$ALIB/expat" 
	cp $ALIB/expat/*.cpp "$TEMP/$ALIB/expat" 
	echo "creating zip file $ZIPOUT..."
	if "$ZIPPER" a -tzip $ZIPOUT $TEMP > /dev/null
	then
		echo "removing temporary files..."
		rm -rf $TEMP
		echo "$ZIPOUT created succesfully"
	else
		error "zip operation failed"
	fi
else
	error "failed to create $TEMP directory"
fi

